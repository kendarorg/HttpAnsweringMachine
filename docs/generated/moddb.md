
<!--This file is autogenerated. Do not edit!-->
In this demo you will 

* Start locally HAM server
* Start the sample application
* Connect to it through proxy
* Record the simplified db interactions of the sample application
* Modify db data on the recording!

For more infos [check here](../generated/testcalendar_internals.md)

## Download the last release<a id="quickinstall_01"></a>

Download the two tar.gz, ham and ham-samples from [github releases](https://github.com/kendarorg/HttpAnsweringMachine/releases)
and extract them in the same directory

## Starting the sample application<a id="quickinstall_02"></a>

Go on the "calendar" directory and run "runcalendardbproxy.bat/sh"

This will start

* H2 db server (tcp://localhost:9123, web console http://localhost:8082)
* ham (localhost:80)
* be (localhost:8100) proxied by http://localhost/int/be.sample.test
* gateway (localhost:8090) proxied by http://localhost/int/gateway.sample.test
* fe (localhost:8080)

First you should choose if you want to recreate the db go for Y the first time

<img src="../images/dbproxy_sample01_rebuild.gif" width="500"/>

Then you will have to wait a bit. Now DO NOT START THE BE!!

<img src="../images/dbproxy_sample02_rebuild.gif" width="500"/>

## The calendar sample project

It's composed of three parts

* FE, that calls gateway for all its needs
* GATEWAY, that acts a "middleman" between FE and BE
* BE, with the database that is called only by the GATEWAY
## Configure proxy<a id="proxy_01"></a>

Should set the proxy to 127.0.0.1 And port 1080 for socks5 or 1081 for http/https

<details>
  <summary>Click me for more explanations</summary>

* Chrome:
    * Install [Proxy Switch Omega](https://chrome.google.com/webstore/detail/proxy-switchyomega/padekgcemlokbadohgkifijomclgjgif)
    * Go to options
    * Add http and https proxy server with
        * Address: 127.0.0.1
        * Port 1081.
      
          <img alt="Ham Proxyes" src="../images/chrome_proxy.gif" width="500"/>
    * Select "proxy" from the extension menu and back to "direct" when you want to disconnect
    * 
      <img alt="Ham Proxyes" src="../images/chrome_proxy_switch.gif" width="100"/>
     
* Firefox
    * Navigate to [about:preferences](about:preferences)
    * Search for "proxy"
    * Click on "Settings"
    * Go to "Manual proxy Configuration"
    * Select the socks5 proxy
        * Address: 127.0.0.1
        * Port 1080
    * Check the "Proxy DNS when using SOCKS v5" flag
    * Clean the settings when needed
  
      <img alt="Ham Proxyes" src="../images/firefox_proxy.gif" width="500"/>
    
</details>


## Record some interaction<a id="recordcalendar_01"></a>

* Now you can start the application on the command line :) and wait for its readiness
* Stop it
* Run the benogen.bat/sh but do not press a key to continue!

You can now check the configuration

* Going on [ham proxyes](http://www.local.test/proxy/index.html) you can verify that all proxies are ok if they don't work just "Refresh Status"

<img alt="Ham Proxyes" src="../images/ham_proxies.gif" width="500"/>

* And a db proxy for be

<img alt="Ham Proxyes" src="../images/dbproxy.gif" width="500"/>

* Then you can create a recording on the [recording page](http://www.local.test/plugins/recording)

<img alt="Create recording" src="../images/create_recording.gif" width="500"/>

* Set the recording with the simplified recording! This will record only "most important" stuffs. What can't be simulated will be recorded

<img alt="Create recording" src="../images/dbmod_01.gif" width="500"/>

* Once you create the recording you can start recording! <b>CHECKING THE "Record db calls"</b>

<img alt="Start recording" src="../images/dbproxy_sample03_recorddb.gif" width="700"/>

* Now you can press the key on the benogen! And start the application
* Wait for its start

* Go then on the [application](http://www.sample.test) and do some interaction
  * Add an Employee "John Doe"
  * Go on Appointements
  * Add an Appointment with "Doctor" as description
  * Change the state of the appointament till it shows "Confirmed"
  * Delete the appointment
  * Back on employee, delete the employee too
* And stop the recording!
* Now you will se all the calls on the just created recording
* First the hibernate initialization phase

<img alt="Start recording" src="../images/dbproxy_sample04_hibernateinit.gif" width="500"/>

* ..or see how an employee is created. 
  * First a post to the gateway
  * Forwarded to the be
  * Then the be opens the connections and run the query

<img alt="Start recording" src="../images/dbproxy_sample05_insertemployee.gif" width="500"/>

* You can even see the details of the queries there are many visualisations available
  * JSON: the native format of Janus-Jdbc (editable)
  * Component: the "easy editable visualisation", when available
  * Tree: the structure of the json message (that include the data types)

<img alt="Start recording" src="../images/dbproxy_sample06_exampleview.gif" width="500"/>

Analyzing the Json we identify a prepared statement with one Long parameter with 
set the index 1 (the first to set JDBC prepared statement parameters)

<pre>
{
	"command": {
		"sql": "
            select 
              employee0_.id as id1_1_0_, 
              employee0_.name as name2_1_0_, 
              employee0_.role as role3_1_0_ 
            from 
              employee employee0_ 
            where employee0_.id=?",
		":sql:": "java.lang.String",
		"parameters": [
			{
				"_": {
					"columnindex": 1,
					":columnindex:": "java.lang.Integer",
					"value": 0,
					":value:": "java.lang.Long"
				},
				":_:": "org.kendar.janus.cmd.preparedstatement.parameters.LongParameter"
			}
		],
		":parameters:": "java.util.ArrayList"
	},
	":command:": "org.kendar.janus.cmd.preparedstatement.PreparedStatementExecuteQuery"
}
</pre>




## Replay everything!

* Select all 'http' type calls and delete them

<img alt="Create recording" src="../images/dbmod_02.gif" width="500"/>

* "Download" the recording as "SimplifiedDb.json"
* Look for the first PreparedStatement/executeQuery and edit it

<img alt="Create recording" src="../images/dbmod_03.gif" width="500"/>

* Go then on RESDATA/COMPONENT

<img alt="Create recording" src="../images/dbmod_04.gif" width="500"/>

* Add a row (1), save the JdbcResultSet (2) and the Selected item (3)

<img alt="Create recording" src="../images/dbmod_05.gif" width="500"/>

* Stop the benogen
* Play the recording with the "Use simulated engine" checked

<img alt="Create recording" src="../images/dbmod_01.gif" width="500"/>

* Restart the benogen!
* Go on www.sample test and be happy :)

<img alt="Create recording" src="../images/dbmod_06.gif" width="500"/>