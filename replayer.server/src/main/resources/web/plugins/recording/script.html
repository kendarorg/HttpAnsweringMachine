<html>
<head>
    <link href="/libs/bootstrap.min.css" rel="stylesheet"/>
    <script src="/libs/jquery-3.2.1.min.js"></script>
    <script src="/libs/bootstrap.min.js"></script>
    <link href="/app/app.css" rel="stylesheet"/>
</head>
<body>
<div class="container">
    <div class="row">

        <div class="col-md-8">
            <br>
            <button type="button"  class="btn btn-default" onClick="location.href='index.html'">Scripts</button>
        </div>
        <div class="col-md-8">
            <br>
            <button id="startrecording" name="startrecording" type="button"  class="btn btn-default" onClick="executeAct('start','recording');">Start Recording</button>
            <button id="pauserecording" name="pauserecording" type="button"  class="btn btn-default" onClick="executeAct('pause','recording');">Pause Recording</button>
            <button id="stoprecording" name="stoprecording" type="button"  class="btn btn-default" onClick="executeAct('stop','recording');">Stop Recording</button>

        </div>
        <div class="col-md-8">
            <br>
            <button id="startreplaying" name="startreplaying" type="button"  class="btn btn-default" onClick="executeAct('start','replaying');">Start Replaying</button>
            <button id="pausereplaying" name="pausereplaying" type="button"  class="btn btn-default" onClick="executeAct('pause','replaying');">Pause Replaying</button>
            <button id="stopreplaying" name="stopreplaying" type="button"  class="btn btn-default" onClick="executeAct('stop','replaying');">Stop Replaying</button>

        </div>
        <div class="col-md-8">
            <h3>SCRIPT</h3>
        </div>
        <div class="col-md-8">
            <br>
            <button id="save" name="save" type="button"  class="btn btn-default" onClick="save();">Save</button>

        </div>
        <div class="col-md-8">
            <br>
            <div class="form-group">
                <label for="id">Id</label>
                <input class="form-control" readonly type="text" name="id" id="id" />
            </div>
            <div class="form-group">
                <label for="description">Description</label>
                <input class="form-control" type="text" name="description" id="description" />
            </div>
        </div>

        <div class="col-md-8">
            <h4>FILTER</h4>
        </div>
        <div class="col-md-8">
            <br>
            <div class="form-group">
                <label for="src">Source</label>
                <input class="form-control" type="text" name="src" id="src" />
            </div>
            <div class="form-group">
                <label for="dst">Destination</label>
                <input class="form-control" type="text" name="dst" id="dst" />
            </div>
            <div class="form-group">
                <label for="test">Test</label>
                <input class="form-control" type="text" name="test" id="test" />
            </div>
        </div>
        <div class="col-md-8">
            <table class="table table-striped" id="linesTable">
                <tr>
                    <th>Id</th>
                    <th>Method</th>
                    <th>Host</th>
                    <th>Path</th>
                    <th>Query</th>
                    <th>Res.Status</th>
                    <th>Req.Body</th>
                    <th>Res.Body</th>
                    <th colspan="2">
                        <button class="btn btn-danger form-control"
                                onClick="addLine();">Add</button>
                    </th>
                </tr>
            </table>
        </div>
    </div>
</div>
<script src="/app/app.js"></script>
<script>
    var fields = ['id','request.method','request.host','request.path','_queryCalc','response.statusCode',
        '_requestHashCalc','_responseHashCalc'];
    var linesTable = new SimpleGrid("Request-Response","linesTable","id",fields,
        null,
        function (table,id) {
            location.href = "line.html?line="+id+"&id="+getUrlParameter("id");
        },
        function (table,id) {
            table.deleteFromTable(id,function(id,success,error){
                $.ajax({
                    url: "/api/plugins/replayer/recording/"+getUrlParameter("id")+"/line/" + id,
                    type: 'DELETE',
                    success: function (res) {
                        success();
                    },
                    error:function(res){
                        error();
                    }
                });
            });
        },null);


    handleStateButtons(null);
    $.ajax({
        url: "/api/plugins/replayer/recording/"+getUrlParameter("id"),
        type: 'GET',
        success: function(res) {
            retrieveScriptStatuses(res["lines"].length);
            $("#description").val(res['description']);
            if(res['filter']!=undefined){
                $("#dst").val(res['filter']['dst']);
                $("#src").val(res['filter']['src']);
                $("#test").val(res['filter']['test']);
            }
            $("#id").val(res['id']);
            for(var v=0;v<res["lines"].length;v++) {
                var line =res["lines"][v];
                line['_responseHashCalc']="No";
                line['_requestHashCalc']="No";
                line['_queryCalc']=calculateQuery(line['request']['query']);
                if(line['responseHash']!="0")line['_responseHashCalc']="Yes";
                if(line['requestHash']!="0")line['_requestHashCalc']="Yes";
                //tSource,tableId,id,data,fields
                linesTable.appendToTable(line);
            }
        }
    });

    function calculateQuery(query){
        var result ="";
        $.each(query, function (i, v) {
            if(result!="")result+="&";
            result+=i+"="+v;
        });
        return result;
    }

    function addLine(){
        var maxValue = 0;
        for(var i=0;i<linesTable.data.length;i++){
            var curr = linesTable.data[i];
            if(curr['id']>maxValue){
                maxValue=curr['id'];
            }
        }
        maxValue++;
        location.href = "line.html?line="+maxValue+"&id="+getUrlParameter("id");
    }

    function retrieveScriptStatuses(linesCount){
        $.ajax({
            url: "/api/plugins/replayer/recording",
            type: 'GET',
            success: function(res) {
                var currentId = getUrlParameter("id");
                var active=null;
                var current=null;
                for(var i=0;i<res.length;i++){
                    var script = res[i];
                    if(script.state!="NONE" && script.state!=undefined && script.state!=""){
                        active=script;
                    }
                    if(script.id==currentId){
                        current=script;
                    }
                }
                if( (active==null || current.id==active.id) && current!=null){
                    if(current.state==undefined || current.state==""){
                        current.state="NONE";
                    }
                    handleStateButtons(current.state,linesCount);
                }else{
                    handleStateButtons("NONE",linesCount);
                }
            }
        });
    }

    function executeAct(action,type){
        var id = getUrlParameter("id");
        var type = type=="recording"?"record":"replay";
        var url = "/api/plugins/replayer/recording/"+id+"/"+type+"/"+action;
        $.ajax({
            url: url,
            type: 'GET',
            success: function(res) {
                location.reload();
            }
        });
    }

    function handleStateButtons(state,linesCount){
        var buttons = {"startrecording":false,"pauserecording":false,"stoprecording":false,
            "startreplaying":false,"pausereplaying":false,"stopreplaying":false,"save":false};
        if(state=="NONE"){
            if(linesCount==0)buttons["startrecording"]=true;
            if(linesCount>0)buttons["startreplaying"]=true;
            buttons['save']=true;
        }else if(state=="RECORDING"){
            buttons["pauserecording"]=true;
            buttons["stoprecording"]=true;
        }else if(state=="PAUSED_RECORDING"){
            buttons["startrecording"]=true;
            buttons["stoprecording"]=true;
        }else if(state=="REPLAYING"){
            buttons["pausereplaying"]=true;
            buttons["stopreplaying"]=true;
        }else if(state=="PAUSED_REPLAYING"){
            buttons["startreplaying"]=true;
            buttons["stopreplaying"]=true;
        }
        for (var key in buttons) {
            var visible = buttons[key];
            if(!visible) $("#"+key).hide();
            else $("#"+key).show();
        }
    }

    function save(){
        var id = getUrlParameter("id");
        var data = {
            id:id,
            description: $("#description").val(),
            filter:{
                dst:$("#dst").val(),
                src:$("#src").val(),
                test:$("#test").val(),
            }
        };
        $.ajax({
            url: '/api/plugins/replayer/recording/'+id,
            type: 'put',
            data: JSON.stringify(data),
            contentType: "application/json",
            success: function(response){
                location.reload();
            }
        });
    }
</script>
</body>
</html>