<html>
<head>
    <link href="/libs/bootstrap.min.css" rel="stylesheet"/>
    <script src="/libs/jquery-3.2.1.min.js"></script>
    <script src="/libs/bootstrap.min.js"></script>
    <script src="/libs/lodash.js"></script>
    <link href="/app/app.css" rel="stylesheet"/>
</head>
<body>
<div class="container">
    <div class="row">

        <div class="col-md-8">
            <br>
            <button type="button"  class="btn btn-default" onClick="location.href='../../index.html'">Main</button>
            <button type="button"  class="btn btn-default" onClick="location.href='../index.html'">Plugins</button>
            <button type="button"  class="btn btn-default" onClick="location.href='index.html'">Scripts</button>
        </div>
        <div class="col-md-8">
            <br>
            <button id="startrecording" name="startrecording" type="button"  class="btn btn-default" onClick="executeAct('start','record');">Start Recording</button>
            <button id="pauserecording" name="pauserecording" type="button"  class="btn btn-default" onClick="executeAct('pause','record');">Pause Recording</button>
            <button id="stoprecording" name="stoprecording" type="button"  class="btn btn-default" onClick="executeAct('stop','record');">Stop Recording</button>

        </div>
        <div class="col-md-8">
            <br>
            <button id="startreplaying" name="startreplaying" type="button"  class="btn btn-default" onClick="executeAct('start','replay');">Start Replaying</button>
            <button id="pausereplaying" name="pausereplaying" type="button"  class="btn btn-default" onClick="executeAct('pause','replay');">Pause Replaying</button>
            <button id="stopreplaying" name="stopreplaying" type="button"  class="btn btn-default" onClick="executeAct('stop','replay');">Stop Replaying</button>
        </div>
        <div class="col-md-8">
            <br>
            <button id="play_pact" name="play_pact" type="button"  class="btn btn-default" onClick="executeAct('start','pact');">Start PACT</button>
            <button id="stop_pact" name="stop_pact" type="button"  class="btn btn-default" onClick="executeAct('stop','pact');">Stop PACT</button>
        </div>
        <div class="col-md-8">
            <br>
            <button id="play_null" name="play_null" type="button"  class="btn btn-default" onClick="executeAct('start','null');">Start NULL</button>
            <button id="stop_null" name="stop_null" type="button"  class="btn btn-default" onClick="executeAct('stop','null');">Stop NULL</button>
        </div>
        <div class="col-md-8">
            <h3>SCRIPT</h3>
        </div>
        <div class="col-md-8">
            <br>
            <button id="save" name="save" type="button"  class="btn btn-default" onClick="save();">Save</button>
            <button id="download" name="download" type="button"  class="btn btn-default" onClick="download();">Download</button>
            <button id="downloadTest" name="downloadTest" type="button"  class="btn btn-default" onClick="downloadTest();">Download test project</button>
        </div>
        <div class="col-md-8">
            <br>
            <div class="form-group">
                <label for="id">Id</label>
                <input class="form-control" readonly type="text" name="id" id="id" />
            </div>
            <div class="form-group">
                <label for="description">Description</label>
                <input class="form-control" type="text" name="description" id="description" />
            </div>
        </div>

        <div class="col-md-8">
            <h4>FILTER</h4>
        </div>
        <div class="col-md-8">
            <br>
            <div class="form-group">
                <label for="src">Source</label>
                <input class="form-control" type="text" name="src" id="src" />
            </div>
            <div class="form-group">
                <label for="dst">Destination</label>
                <input class="form-control" type="text" name="dst" id="dst" />
            </div>
            <div class="form-group">
                <label for="test">Test</label>
                <input class="form-control" type="text" name="test" id="test" />
            </div>
        </div>

        <div class="col-md-8">
            <ul>
                <li class="tab-switcher" data-tab-index="0" tabindex="0">
                    Script
                </li>
                <li class="tab-switcher" data-tab-index="1" tabindex="0">
                    Full path
                </li>
            </ul>
        <!--<ul class="nav nav-tabs">
            <li class="active"><a data-toggle="tab" href="#optimizedscript">Script</a></li>
            <li><a data-toggle="tab" href="#fullpath">Full path</a></li>
        </ul>-->
            <div id="allTabsContainer">
                <div class="tab-container" data-tab-index="0">
                <h3>Script</h3>
                <div class="col-md-8">
                    <button id="script_deleteselected" name="script_deleteselected" type="button"  class="btn btn-default" onClick="deleteSelected();">Delete Selected</button>
                    <button id="script_selectall" name="script_selectall" type="button"  class="btn btn-default" onClick="selectall();">Select All</button>
                    <button id="script_deselectall" name="script_deselectall" type="button"  class="btn btn-default" onClick="unselectall();">Unselect All</button>
                    <button id="script_clone" name="script_clone" type="button"  class="btn btn-default" onClick="cloneselected();">Clone Selected</button>
                    <button id="script_togglestimulatedselected" name="script_togglestimulatedselected" type="button"  class="btn btn-default" onClick="togglestimulatedselected();">Toggle selected as stimulated</button>
                    <br>
                </div>
                <div class="col-md-8">
                    <table class="table table-striped" id="linesTable" id="linesTable">
                        <tr>
                            <th>Selected</th>
                            <th>Id</th>
                            <th>Stimulated Test</th>
                            <th>Method</th>
                            <th>Host</th>
                            <th>Path</th>
                            <th>Query</th>
                            <th>Res.Status</th>
                            <th>Req.Body</th>
                            <th>Res.Body</th>
                            <th>Pre Script</th>
                            <th>Script</th>
                            <th></th>
                            <th colspan="2">
                                <button class="btn btn-danger form-control"
                                        id="script_addline" name="script_addline"
                                        onClick="addLine();">Add</button>
                            </th>
                        </tr>
                    </table>
                </div>
            </div>
                <div class="tab-container" data-tab-index="1"  style="display:none;">
                <h3>Full path</h3>
                <div class="col-md-8">
                    <button id="full_togglepactselected" name="full_togglepactselected" type="button"  class="btn btn-default" onClick="togglepactselected();">Toggle selected as PACT</button>
                    <button id="full_togglestimulatorselected" name="full_togglestimulatorselected" type="button"  class="btn btn-default" onClick="togglestimulatorselected();">Toggle selected as stimulator</button>
                    <button id="full_selectall" name="full_selectall" type="button"  class="btn btn-default" onClick="full_selectall();">Select All</button>
                    <button id="full_deselectall" name="full_deselectall" type="button"  class="btn btn-default" onClick="full_unselectall();">Unselect All</button>
                    <br>
                </div>
                <div class="col-md-8">
                    <table class="table table-striped" id="allCalls" name="allCalls">
                        <tr>
                            <th>Selected</th>
                            <th>Id</th>
                            <th>Pact Test</th>
                            <th>Stimulator Test</th>
                            <th>Method</th>
                            <th>Host</th>
                            <th>Path</th>
                            <th>Query</th>
                            <th>Res.Status</th>
                            <th>Req.Body</th>
                            <th>Res.Body</th>
                            <th>Pre Script</th>
                            <th>Script</th>
                            <th></th>
                            <th colspan="2">
                                <!--<button class="btn btn-danger form-control"
                                        onClick="addLine();">Add</button>-->
                            </th>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
            </div>


    </div>
</div>
<!-- Modal -->
<div aria-labelledby="myModalLabel" class="modal fade" id="myModal" role="dialog" tabindex="-1">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button aria-label="Close" class="close" data-dismiss="modal" type="button">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title" id="myModalLabel">Update User</h4>
            </div>
            <div class="modal-body"></div>
            <div class="modal-footer"></div>
        </div>
    </div>
</div>
<script src="/app/app.js"></script>
<script>

    var previousActiveTabIndex = 0;
    $(".tab-switcher").on('click keypress', function (event) {
        // event.which === 13 means the "Enter" key is pressed
        if ((event.type === "keypress" && event.which === 13) || event.type === "click") {
            var tabClicked = $(this).data("tab-index");
            if(tabClicked != previousActiveTabIndex) {
                $("#allTabsContainer .tab-container").each(function () {
                    if($(this).data("tab-index") == tabClicked) {
                        $(".tab-container").hide();
                        $(this).show();
                        previousActiveTabIndex = $(this).data("tab-index");
                        return;
                    }
                });
            }
        }
    });

    var scriptModal = `
            <div class="form-group">
    <label for="line">line</label>
    <input class="form-control" type="text" name="line"  id="line" />
    </div>
            <div class="form-group">
                <label for="jsScript">jsScript</label>
                <textarea class="form-control" rows="6" cols="50" name="jsScript" id="jsScript"></textarea>
            </div>
    `;

    var saveScript = function(url,data){

        $.ajax({
            url: url,
            type: 'PUT',
            data: data,
            contentType: "text/plain",
            success: function(response){
                location.reload();
            }});
    }

    var setScript = function(line,isPre){

        var url = "/api/plugins/replayer/recording/"+getUrlParameter("id")+"/script/"+line+"?pre=";
        url+= isPre?"true":"false";
        $.ajax({
            url: url,
            type: 'GET',
            success: function (res) {
                var modal=".modal";
                var randomId = "BUTTON"+Math.floor(Math.random() * 999999999);
                var target = {
                    compositeId :getUrlParameter("id")+"|"+line+"|"+(isPre?1:0),
                    id : getUrlParameter("id"),
                    line : line,
                    index : isPre,
                    data:res,
                    jsScript:res
                };
                buildGenericModal(modal, null,target, "compositeId", scriptModal, randomId,true);
                $(modal).find("#jsScript").val(res);
                $(modal).find("#line").val(line);
                $(modal).find("#"+randomId).click(function(){
                    target.data=$(modal).find("#jsScript").val();
                    saveScript(url,target.data)
                });
            }});
    }

    var buttonsMask=[
        {id:["startreplaying"],states:["PAUSED_REPLAYING","NONE"]},
        {id:["stopreplaying"],states:["PAUSED_REPLAYING","REPLAYING"]},
        {id:["pausereplaying"],states:["REPLAYING"]},
        {id:["startrecording"],states:["NONE","PAUSED_RECORDING"],callback:function(){
                return linesTable.data.length==0;
            }},
        {id:["stoprecording"],states:["RECORDING","PAUSED_RECORDING"]},
        {id:["pauserecording"],states:["RECORDING"]},
        //{id:["script_clone"],states:["NONE","OTHER_RUNNING"]},
        {id:["save"],states:["NONE","OTHER_RUNNING"]},

        {id:["script_addline","script_deleteselected","script_togglestimulatorseleted"],states:["NONE","OTHER_RUNNING"]},

        {id:["script_togglestimulatorseleted","script_togglepactselected"],states:["NONE","OTHER_RUNNING"]},

        {id:["play_pact"],states:["NONE"]},
        {id:["stop_pact"],states:["PLAYING_PACT"]},

        {id:["play_null"],states:["NONE"]},
        {id:["stop_null"],states:["PLAYING_NULL_INFRASTRUCTURE"]}
    ];



    var checkButtons = function(){
        $.ajax({
            url: "/api/plugins/replayer/status",
            type: 'GET',
            success: function (res) {
                var status = res["status"].toUpperCase();
                var running = res["running"].toUpperCase();
                var thisScript = getUrlParameter("id").toUpperCase();
                if(status!="NONE" && thisScript!=running){
                    status="OTHER_RUNNING";
                }
                buttonEnabler(buttonsMask,status);
            }});
    };

    longPolling(1000,function(){
       checkButtons();
    });

    //'_pactTest','_stimulatorTest
    var loadIndexData = function(table){
        $.ajax({
            url: "/api/plugins/replayer/recording/" + getUrlParameter("id"),
            type: 'GET',
            success: function (res) {
                $("#description").val(res['description']);
                if (res['filter'] != undefined) {
                    $("#dst").val(res['filter']['dst']);
                    $("#src").val(res['filter']['src']);
                    $("#test").val(res['filter']['test']);
                }
                $("#id").val(res['id']);

                //Load lines
                var lines = res["lines"];
                //Load indexes
                var indexes = res['indexes'];
                var prescripts= res['preScript'];
                var postscripts= res['postScript'];
                for (var v = 0; v < indexes.length; v++) {
                    var indexline = indexes[v];
                    var line = _.find(lines, function (o) {
                        return indexline['reference'] == o['id'];
                    });
                    if(line == undefined) continue;
                    line = JSON.parse(JSON.stringify(line));
                    line['id'] = indexline['id'];
                    line['_selected'] = `<div class="form-check">
<label class="form-check-label">
                <input class="form-check-input"  type="checkbox" value="false" id="selected_` + line['id'] + `" name="selected_`+line['id']+`">
</label>
            </div>`
                    line['_responseHashCalc'] = "No";
                    line['_requestHashCalc'] = "No";
                    var checkedItem = indexline['pactTest']?"checked='checked' value='true'":"value='false'";
                    line['_pactTest'] = `<div class="form-check">
<label class="form-check-label">
                <input class="form-check-input"  type="checkbox" `+checkedItem+` id="pactTest_` + line['id'] + `" name="pactTest_`+line['id']+`">
</label>
            </div>`;
                    checkedItem = indexline['stimulatorTest']?"checked='checked' value='true'":"value='false'";
                    line['_stimulatorTest'] = `<div class="form-check">
<label class="form-check-label">
                <input class="form-check-input"  type="checkbox" `+checkedItem+` id="stimulatorTest_` + line['id'] + `" name="stimulatorTest_`+line['id']+`">
</label>
            </div>`;
                    setChecked($('#allCalls #pactTest_'+line['id']),indexline['pactTest']);
                    setChecked($('#allCalls #stimulatorTest_'+line['id']),indexline['stimulatorTest']);
                    line['_queryCalc'] = calculateQuery(line['request']['query']);
                    line['_script'] = (line['id'] in postscripts)?"Yes":"No";
                    line['_preScript'] = (line['id'] in prescripts)?"Yes":"No";
                    if (line['responseHash'] != "0") line['_responseHashCalc'] = "Yes";
                    if (line['requestHash'] != "0") line['_requestHashCalc'] = "Yes";
                    line['_editScript'] = `<button type="button" onclick="setScript(`+line['id']+`,false)" class="btn btn-default">Edit</button>`;
                    line['_editPreScript'] = `<button type="button" onclick="setScript(`+line['id']+`,true)" class="btn btn-default">Edit</button>`;
                    //tSource,tableId,id,data,fields
                    allCalls.appendToTable(line,false);
                }
            }
        });
    }
    var loadTableData = function(table){

        $.ajax({
            url: "/api/plugins/replayer/recording/" + getUrlParameter("id"),
            type: 'GET',
            success: function (res) {
                $("#description").val(res['description']);
                if (res['filter'] != undefined) {
                    $("#dst").val(res['filter']['dst']);
                    $("#src").val(res['filter']['src']);
                    $("#test").val(res['filter']['test']);
                }
                $("#id").val(res['id']);

                //Load lines
                var lines = res["lines"];
                var prescripts= res['preScript'];
                var postscripts= res['postScript'];
                for (var v = 0; v < lines.length; v++) {
                    var line = lines[v];
                    line['_selected'] = `<div class="form-check">
                <input class="form-check-input" type="checkbox" value="" id="selected_` + line['id'] + `" name="selected_\`+line['id']+\`">

            </div>`;
                    line['_responseHashCalc'] = "No";
                    line['_requestHashCalc'] = "No";
                    var checkedItem = line['stimulatedTest']?"checked='checked' value='true'":"value='false'";
                    line['_stimulatedTest'] = `<div class="form-check">
                <input class="form-check-input" type="checkbox" `+checkedItem+` value="" id="stimulatedTest_` + line['id'] + `" name="stimulatedTest_`+line['id']+`">
            </div>`;

                    line['_script'] = (line['id'] in postscripts)?"Yes":"No";
                    line['_preScript'] = (line['id'] in prescripts)?"Yes":"No";
                    line['_queryCalc'] = calculateQuery(line['request']['query']);
                    if (line['responseHash'] != "0") line['_responseHashCalc'] = "Yes";
                    if (line['requestHash'] != "0") line['_requestHashCalc'] = "Yes";
                    //tSource,tableId,id,data,fields
                    setChecked($('#linesTable #stimulatedTest_'+line['id']),line['stimulatedTest']);
                    line['_editScript'] = `<button type="button" onclick="setScript(`+line['id']+`,false)" class="btn btn-default">Edit</button>`;
                    line['_editPreScript'] = `<button type="button" onclick="setScript(`+line['id']+`,true)" class="btn btn-default">Edit</button>`;
                    linesTable.appendToTable(line);
                }
            }
        });
    }
    var fields = ['_selected','id','_stimulatedTest','request.method','request.host','request.path','_queryCalc','response.statusCode',
        '_requestHashCalc','_responseHashCalc','_preScript','_script','_editPreScript','_editScript'];
    var linesTable = new SimpleGrid("Request-Response","linesTable","id",fields,
        function(table) {
            loadTableData(table);
        },
        function (table,id) {
            location.href = "line.html?line="+id+"&id="+getUrlParameter("id");
        },
        function (table,id) {
            table.deleteFromTable(id,function(id,success,error){
                $.ajax({
                    url: "/api/plugins/replayer/recording/"+getUrlParameter("id")+"/line/" + id,
                    type: 'DELETE',
                    success: function (res) {
                        success();
                    },
                    error:function(res){
                        error();
                    }
                });
            });
        },null,[
            {id:"id",type:"string"},
            {id:"_stimulatedTest",type:"bool"},
            {id:"_script",type:"bool"},
            {id:"_preScript",type:"bool"},
            {id:"request.host",type:"string"},
            {id:"request.path",type:"string"},
            {id:"request.query",type:"string"}]);
    var fieldsAllCalls = ['_selected','id','_pactTest','_stimulatorTest','request.method','request.host','request.path','_queryCalc','response.statusCode',
        '_requestHashCalc','_responseHashCalc','_preScript','_script','_editPreScript','_editScript'];
    var allCalls = new SimpleGrid("Request-Response","allCalls","id",fieldsAllCalls,
        function (table){
            loadIndexData(table);
        },
        null,
        function (table,id) {
            table.deleteFromTable(id,function(id,success,error){
                $.ajax({
                    url: "/api/plugins/replayer/recording/"+getUrlParameter("id")+"/lineindex/" + id,
                    type: 'DELETE',
                    success: function (res) {
                        success();
                    },
                    error:function(res){
                        error();
                    }
                });
            });
        },null,[
            {id:"id",type:"string"},
            {id:"_pactTest",type:"bool"},
            {id:"_stimulatorTest",type:"bool"},
            {id:"request.host",type:"string"},
            {id:"request.path",type:"string"},
            {id:"_script",type:"bool"},
            {id:"_preScript",type:"bool"},
            {id:"request.query",type:"string"}]);

    function download(){
        window.open("/api/plugins/replayer/recording/"+getUrlParameter("id")+"/full");
    }

    function downloadTest(){
        var pack = prompt("Insert the package");
        window.open("/api/plugins/replayer/generator/"+getUrlParameter("id")+"?package="+pack);
    }

    linesTable.load();
    allCalls.load();



    function calculateQuery(query){
        var result ="";
        $.each(query, function (i, v) {
            if(result!="")result+="&";
            result+=i+"="+v;
        });
        return result;
    }

    function addLine(){
        var maxValue = 0;
        for(var i=0;i<linesTable.data.length;i++){
            var curr = linesTable.data[i];
            if(curr['id']>maxValue){
                maxValue=curr['id'];
            }
        }
        maxValue++;
        location.href = "line.html?line="+maxValue+"&id="+getUrlParameter("id");
    }

    function executeAct(action,usedType){
        var id = getUrlParameter("id");
        var url = "/api/plugins/replayer/recording/"+id+"/"+usedType+"/"+action;
        $.ajax({
            url: url,
            type: 'GET',
            success: function(res) {
                location.reload();
            }
        });
    }

    function getSelectedLines(){

        var result = [];
        linesTable.data.forEach(function (row, i) {
            if($('#linesTable #selected_'+row['id']).prop("checked")) {
                result.push(row['id']);
            }
        });
        return result;
    }

    function cloneselected(){
        var resp = window.prompt("The name of the clone?")
        var id = getUrlParameter("id");
        var data = getSelectedLines();
        $.ajax({
            url: '/api/plugins/replayer/recording/'+id+'/clone/'+resp,
            type: 'post',
            data: JSON.stringify(data),
            contentType: "application/json",
            success: function(response){
                location.reload();
            }
        });
    }

    function deleteSelected(){
        var id = getUrlParameter("id");
        var data = getSelectedLines();
        //
        $.ajax({
            url: '/api/plugins/replayer/recording/'+id+'/deletelines',
            type: 'post',
            data: JSON.stringify(data),
            contentType: "application/json",
            success: function(response){
                location.reload();
            }
        });
    }


    function selectall(){
        linesTable.data.forEach(function (row, i) {
            setChecked($('#linesTable #selected_'+row['id']),true);
        });
    }

    function full_selectall(){
        allCalls.data.forEach(function (row, i) {
            setChecked($('#allCalls #selected_'+row['id']),true);
        });
    }

    function full_unselectall(){
        allCalls.data.forEach(function (row, i) {
            setChecked($('#allCalls #selected_'+row['id']),false);
        });
    }

    function togglestimulatedselected(){
        linesTable.data.forEach(function (row, i) {
            if(!$('#linesTable #selected_'+row['id']).prop("checked"))return;
            toggleCheck($('#linesTable #stimulatedTest_'+row['id']));
        });
    }

    function togglestimulatorselected(){

        allCalls.data.forEach(function (row, i) {
            if(!$('#allCalls #selected_'+row['id']).prop("checked"))return;
            toggleCheck($('#allCalls #stimulatorTest_'+row['id']));
        });
    }
    function togglepactselected(){
        allCalls.data.forEach(function (row, i) {
            if(!$('#allCalls #selected_'+row['id']).prop("checked"))return;
            toggleCheck($('#allCalls #pactTest_'+row['id']));
        });
    }

    function unselectall(){
        linesTable.data.forEach(function (row, i) {
            setChecked($('#linesTable #selected_'+row['id']),false);
        });
    }

    function save(){
        var id = getUrlParameter("id");

        var stimulatedTest = [];
        var pactTest = [];
        var stimulatorTest = [];
        linesTable.data.forEach(function (row, i) {
            if($('#linesTable #stimulatedTest_'+row['id']).prop("checked")){
                stimulatedTest.push(row['id']);
            }
        });

        allCalls.data.forEach(function (row, i) {
            if($('#allCalls #pactTest_'+row['id']).prop("checked")){
                pactTest.push(row['id']);
            }
        });
        allCalls.data.forEach(function (row, i) {
            if($('#allCalls #stimulatorTest_'+row['id']).prop("checked")){
                stimulatorTest.push(row['id']);
            }
        });

        var data = {
            id:id,
            description: $("#description").val(),
            filter:{
                dst:$("#dst").val(),
                src:$("#src").val(),
                test:$("#test").val()
            },
            stimulatorTest:stimulatorTest,
            pactTest:pactTest,
            stimulatedTest:stimulatedTest
        };
        //FIXME: SHOULD SAVE THE TEST STUFFS
        $.ajax({
            url: '/api/plugins/replayer/recording/'+id,
            type: 'put',
            data: JSON.stringify(data),
            contentType: "application/json",
            success: function(response){
                location.reload();
            }
        });
    }
</script>
</body>
</html>