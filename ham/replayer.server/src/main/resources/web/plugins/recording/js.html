<html>
<head>
    <link href="/libs/bootstrap.min.css" rel="stylesheet"/>
    <script src="/libs/jquery-3.2.1.min.js"></script>
    <script src="/libs/bootstrap.min.js"></script>
    <script src="/libs/lodash.js"></script>
    <link href="/app/app.css" rel="stylesheet"/>
</head>
<body>
<div class="container">
    <div class="row">
        <div class="col-md-8">
            <br>
            <button type="button"  class="btn btn-default" onClick="location.href='../../index.html'">Main</button>
            <button type="button"  class="btn btn-default" onClick="location.href='index.html'">Scripts</button>
            <button type="button"  class="btn btn-default" id="backToSingle"  name="backToSingle" >???</button>
            <button type="button" id="prev" name="prev"  class="btn btn-default" onClick="prev()">Prev</button>
            <button type="button" id="next" name="next" class="btn btn-default" onClick="next()">Next</button>
        </div>
        <div class="col-md-8">
            <h3>LINE</h3>
        </div>
        <div class="col-md-8">
            <br>
            <button id="save" name="save" type="button"  class="btn btn-default" onClick="save();">Save</button>
            <button id="delete" name="delete" type="button"  class="btn btn-default" onClick="delete();">Save</button>

        </div>

        <div class="col-md-8">
            <div class="form-group">
                <label htmlFor="id">Id</label>
                <input class="form-control" readOnly type="text" name="id" id="id"/>
            </div>
        </div><div class="col-md-8">
        <h3>REQUEST</h3>
    </div>
        <div class="col-md-8">

            <div class="form-group">
                <label htmlFor="request_method">Method</label>
                <input class="form-control" type="text" name="request_method" id="request_method"/>
            </div>
            <div class="form-group">
                <label htmlFor="request_host">Host</label>
                <input class="form-control" type="text" name="request_host" id="request_host"/>
            </div>
            <div class="form-group">
                <label htmlFor="request_path">Path</label>
                <input class="form-control" type="text" name="request_path" id="request_path"/>
            </div>
        </div>


        <div class="col-md-8">
            <h3>Scripts</h3>
        </div>

        <div class="col-md-8">
            <div class="form-group">
                <label for="jsScriptPre">PRE</label>
                <textarea class="form-control" rows="6" cols="50" name="jsScriptPre" id="jsScriptPre"></textarea>
            </div>
        </div>
        <div class="col-md-8">
            <div class="form-group">
                <label for="jsScriptPre">POST</label>
                <textarea class="form-control" rows="6" cols="50" name="jsScriptPost" id="jsScriptPost"></textarea>
            </div>
        </div>
    </div>
</div>
<!-- Modal -->
<div aria-labelledby="myModalLabel" class="modal fade" id="myModal" role="dialog" tabindex="-1">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button aria-label="Close" class="close" data-dismiss="modal" type="button">
                    <span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title" id="myModalLabel">Update User</h4>
            </div>
            <div class="modal-body"></div>
            <div class="modal-footer"></div>
        </div>
    </div>
</div>
<script src="/app/app.js"></script>
<script>


    var prevLine=-1;
    var nextLine=-1;


    var defaultSaveAction = "put";
    var request_headerTable = new SimpleGrid("Request-Headers","request_headerTable","key",["key","value"],
        null,
        function (table,id) {
            editKvp(".modal",table,id,"key","value")
        },
        function (table,id) {
            deleteKvp(".modal",table,id,"key","value")
        },
        function (table,id,saveOrUpdate) {
            updateKvp(".modal",table,id,"key","value")
        });
    var request_queryTable = new SimpleGrid("Query","request_queryTable","key",["key","value"],
        null,
        function (table,id) {
            editKvp(".modal",table,id,"key","value")
        },
        function (table,id) {
            deleteKvp(".modal",table,id,"key","value")
        },
        function (table,id,saveOrUpdate) {
            updateKvp(".modal",table,id,"key","value")
        });
    var request_postTable = new SimpleGrid("PostParameters","request_postTable","key",["key","value"],
        null,
        function (table,id) {
            editKvp(".modal",table,id,"key","value")
        },
        function (table,id) {
            deleteKvp(".modal",table,id,"key","value")
        },
        function (table,id,saveOrUpdate) {
            updateKvp(".modal",table,id,"key","value")
        });
    var response_headerTable = new SimpleGrid("Response-Headers","response_headerTable","key",["key","value"],
        null,
        function (table,id) {
            editKvp(".modal",table,id,"key","value")
        },
        function (table,id) {
            deleteKvp(".modal",table,id,"key","value")
        },
        function (table,id,saveOrUpdate) {
            updateKvp(".modal",table,id,"key","value")
        });

    var prev = function(){
        location.href="line.html?id="+getUrlParameter("id")+"&line="+prevLine;
    }
    var next = function(){
        location.href="line.html?id="+getUrlParameter("id")+"&line="+nextLine;
    }

    $.ajax({
        url: "/api/plugins/replayer/recording/" + getUrlParameter("id")+"/line/"+getUrlParameter("line"),
        type: 'GET',
        success: function (res, textStatus, request) {
            $("#timestamp").val(res['timestamp']);
            $("#id").val(res['id']);

            prevLine= parseInt(request.getResponseHeader('X-PREV'));
            nextLine= parseInt(request.getResponseHeader('X-NEXT'));

            if(prevLine==-1){
                $("#prev").hide();
            }
            if(nextLine==-1){
                $("#next").hide();
            }

            //Request
            $("#request_method").val(res['request']['method']);
            $("#request_protocol").val(res['request']['protocol']);
            $("#request_host").val(res['request']['host']);
            $("#request_path").val(res['request']['path']);
            $("#request_port").val(res['request']['port']);
            setChecked($("#request_static"),res['request']['staticRequest']);
            setChecked($("#request_soap"),res['request']['soapRequest']);
            setChecked($("#request_binary"),res['request']['binaryRequest']);
            setChecked($("#stimulatedTest"),res['request']['stimulatedTest']);
            var editContent = "text.html";
            if(res['request']['binaryRequest']){
                editContent = "binary.html";
            }
            $("#request_content").click(
                function(){
                    editContent = "text.html";
                    if($("#request_binary").prop("checked")){
                        editContent = "binary.html";
                    }
                    location.href=editContent+"?type=request"+
                        "&id="+getUrlParameter("id")+
                        "&line="+getUrlParameter("line"); });

            $.each(res["request"]["headers"], function (i, v) {
                var line = {key:i,value:v};
                request_headerTable.appendToTable( line);
            });
            $.each(res["request"]["query"], function (i, v) {
                var line = {key:i,value:v};
                request_queryTable.appendToTable(line);
            });
            $.each(res["request"]["postParameters"], function (i, v) {
                var line = {key:i,value:v};
                request_postTable.appendToTable(line);
            });

            //Response
            $("#response_code").val(res['response']['statusCode']);
            setChecked($("#response_binary"),res['response']['binaryResponse']);

            $("#response_content").click(
                function(){
                    editContent = "text.html";
                    if($("#response_binary").prop("checked")){
                        editContent = "binary.html";
                    }
                    location.href=editContent+"?type=response"+
                        "&id="+getUrlParameter("id")+
                        "&line="+getUrlParameter("line"); });

            $.each(res["response"]["headers"], function (i, v) {
                var line = {key:i,value:v};
                response_headerTable.appendToTable(line);
            });

            if(res["requestHash"]!="0" && res["requestHash"]!=""){
                $("#request_content_download").show();
            }else{
                $("#request_content_download").hide();
            }
            if(res["responseHash"]!="0" && res["responseHash"]!=""){
                $("#response_content_download").show();
            }else{
                $("#response_content_download").hide();
            }
        },
        error: function( xhr, textStatus, errorThrown ){
            if(xhr.status==404) {
                $("#timestamp").val(Math.floor(Date.now() / 1000));
                $("#id").val(getUrlParameter("line"));
                $("#request_content").hide();
                $("#response_content").hide();
                $("#request_content_download").hide();
                $("#response_content_download").hide();
                defaultSaveAction="post";
            }
        }
    });

    $("#request_content_download").click(function(){
        downloadFile("/api/plugins/replayer/recording/" + getUrlParameter("id")+"/line/"+getUrlParameter("line")+"/request");
    });

    $("#response_content_download").click(function(){
        downloadFile("/api/plugins/replayer/recording/" + getUrlParameter("id")+"/line/"+getUrlParameter("line")+"/response");
    });

    $("#backToSingle").click(function(){
        location.href="script.html?id="+getUrlParameter("id"); })
        .html(getUrlParameter("id"));



    function save(){
        var id = getUrlParameter("id");
        var line = getUrlParameter("line");
        var data = {
            id:$("#id").val(),
            timestamp: $("#timestamp").val(),
            stimulatedTest:$("#stimulatedTest").prop("checked"),
            request:{
                method:$("#request_method").val(),
                protocol:$("#request_protocol").val(),
                host:$("#request_host").val(),
                path:$("#request_path").val(),
                port:$("#request_port").val(),
                staticRequest:$("#request_static").prop("checked"),
                soapRequest:$("#request_soap").prop("checked"),
                binaryRequest:$("#request_binary").prop("checked"),
                headers:getKvpData(request_headerTable,"key","value"),
                query:getKvpData(request_queryTable,"key","value"),
                postParameters:getKvpData(request_postTable,"key","value"),
            },
            response:{
                statusCode:$("#response_code").val(),
                binaryResponse:$("#response_binary").prop("checked"),
                headers:getKvpData(response_headerTable,"key","value"),
            }
        };
        $.ajax({
            url: '/api/plugins/replayer/recording/'+id+'/line/'+line,
            type: defaultSaveAction,
            data: JSON.stringify(data),
            contentType: "application/json",
            success: function(response){
                location.reload();
            }
        });
    }

    function addRequestQuery(){
        addKvp('.modal',request_queryTable,'key','value');
    }

    function addRequestPost(){
        addKvp('.modal',request_postTable,'key','value');
    }

    function addRequestHeader(){
        addKvp('.modal',request_headerTable,'key','value');
    }

    function addResponseHeader(){
        addKvp('.modal',response_headerTable,'key','value');
    }
</script>
</body>
</html>