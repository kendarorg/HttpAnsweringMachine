<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link href="/libs/bootstrap.min.css" rel="stylesheet"/>
    <script src="/libs/vue.js"></script>
    <script src="/libs/httpVueLoader.js"></script>
    <script src="/libs/axios.min.js"></script>
    <link rel="stylesheet" type="text/css" href="/vcss/style.css" />
</head>
<body>

<div class="container" id="app">
    <simple-modal v-if="dnsServerModalShow"
                  :modal-data="dnsServerModalData"
                  @close="dnsServerModalShow = false">
        <span slot="header">Dns Server</span>
        <span slot="body"><change-dns-server :data="dnsServerModalData.data"/></span>
    </simple-modal>
    <div class="row">
        <div class="col-md-8">
            <br>
            <button type="button"  class="btn btn-default" onClick="location.href='../index.html'">Main</button>
            <button type="button"  class="btn btn-default" onClick="location.href='resolved.html'">Resolved</button>

        </div>
        <div class="col-md-8">
            <h3>DNS Servers</h3>
            <button v-on:click="dnsServerReload()" class="btn btn-primary btn-sm">Reload</button>
            <button v-on:click="dnsServerAddNew(false,[])" class="btn btn-primary btn-sm">Add new</button>
            <simple-grid
                    v-on:gridclicked="dnsServerGridClicked"
                    ref="dnsServerGrid"
                    :columns="dnsServerColumns"
                    :extra="dnsServerExtraColumns"
                    :retrieve-data="dnsServerRetrieveData"
            >
            </simple-grid>
        </div>
        <div class="col-md-8">
            <h3>DNS Mappings</h3>
            <button id="hostsfile" name="hostsfile" type="button"  class="btn btn-default" onClick="hostsfile();">
                <i class="bi bi-signpost"></i>Download hosts file</button>
            <br>
            <table class="table table-striped" id="dnsMappingTable">
                <tr>
                    <th>Id</th>
                    <th>Ip</th>
                    <th>Dns</th>
                    <th colspan="2">
                        <button id="addDnsMapping" name="addDnsMapping" type="button"  class="btn btn-default" onClick="addDnsMapping();">Add new mapping</button>
                    </th>
                </tr>
            </table>
        </div>
    </div>
</div>
<script>
    new Vue({
        el: '#app',
        components: {
            'simple-grid': httpVueLoader('/vcomponents/testgrid.vue'),
            'kvp-modal': httpVueLoader('/vcomponents/tkvpmodal.vue'),
            'simple-modal': httpVueLoader('/vcomponents/tmodal.vue'),
            'change-dns-server': httpVueLoader('/dns/veditdnsserver.vue')
        },
        data: {
            dnsServerModalData:null,
            dnsServerModalShow:false,
            dnsServerColumns: [
                {id:"id",template:"string",index:true},
                {id:"address",template:"string"},
                {id:"resolved",template:"string"},
                {id:"enabled",template:"bool"}
            ],
            dnsServerExtraColumns: [
                {id:"_edit",template:"button",default:false,searchable:false,sortable:false,properties:{
                        name:"Edit",style:"btn btn-success btn-sm"}},
                {id:"_delete",template:"button",default:false,searchable:false,sortable:false,properties:{
                        name:"Delete",style:"btn btn-danger btn-sm"}}
            ],

        },
        methods: {
            dnsServerRetrieveData: async function(){
                var result = await axios.get("/api/dns/servers");
                return result;
            },
            dnsServerGridClicked: async function(evt){
                var row = this.$refs.dnsServerGrid.getById(evt.index);

                if(evt.buttonid=="_edit"){
                    this.dnsServerAddNew(true,evt.index)
                }else if(evt.buttonid=="_delete"){
                    await axios.delete("/api/dns/servers/"+row['id'])
                    this.dnsServerReload();
                }
            },
            dnsServerReload:function(){
                this.$refs.dnsServerGrid.reload();
            },
            dnsServerAddNew:function(shouldEdit,rowId){
                var row = null;
                if(shouldEdit) {
                    row = this.$refs.dnsServerGrid.getById(rowId);
                }else{
                    row = {
                        id:URL.createObjectURL(new Blob([])).substr(-36)
                    }
                }
                this.dnsServerModalData={
                    data:row,
                    edit:shouldEdit,
                    save:this.dnsServerSave
                };
                this.dnsServerModalShow=true;
            },
            dnsServerSave:async function(){
                if(this.dnsServerModalData.edit){
                    await axios.put('/api/dns/servers/'+this.dnsServerModalData.data.id, this.dnsServerModalData.data).then(()=>{
                        this.dnsServerModalShow=false;
                        this.dnsServerReload();
                    });
                }else{
                    await axios.post('/api/dns/servers', this.dnsServerModalData.data).then(()=>{
                        this.dnsServerModalShow=false;
                        this.dnsServerReload();
                    });
                }
            }
        }
    });
</script>
</body>
</html>