<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link href="/libs/bootstrap.min.css" rel="stylesheet"/>
    <link href="/libs/icons/bootstrap-icons.css" rel="stylesheet"/>
    <script src="/libs/vue.js"></script>
    <script src="/libs/httpVueLoader.js"></script>
    <script src="/libs/axios.min.js"></script>
    <script src="/libs/utils.js"></script>
    <link rel="stylesheet" type="text/css" href="/vcss/style.css" />
</head>
<body>

<div class="container" id="app">
    <div class="row">
        <div class="col-md-8">
            <br>
            <button type="button"  class="btn btn-default" onClick="location.href='../index.html'">Main</button>
        </div>

        <div class="col-md-8">

            <div class="form-group">
                <label for="id">Id</label>
                <input class="form-control" readonly type="text" name="id" id="id" v-model="data.id"/>
            </div>
            <div class="form-group">
                <label for="name">Name</label>
                <input class="form-control" type="text" name="name" id="name" v-model="data.name"/>
            </div>
            <div class="form-group">
                <label for="description">Description</label>
                <textarea class="form-control" rows="6" cols="50"
                          name="description" id="description"
                          v-model="data.description"></textarea>
            </div>
            <br>
            <button type="button" :disabled="buttons.save" class="bi bi-floppy" @click="saveRecordingData" title="Save">Save</button>&nbsp;
            <button type="button" :disabled="buttons.record"  class="bi bi-record-btn" @click="executeAct('start','record')" title="Save">Record</button>&nbsp;
            <button type="button" :disabled="buttons.stop"  class="bi bi-stop-btn" @click="executeAct('stop')" title="Save">Stop</button>&nbsp;
            <button type="button" :disabled="buttons.play"  class="bi bi-play-btn" @click="executeAct('start','replay')" title="Save">Play</button>&nbsp;
            <button type="button" :disabled="buttons.pact"  class="bi bi-pencil-square" @click="executeAct('start','pact')" title="Save">Play Pact</button>&nbsp;
            <button type="button" :disabled="buttons.nullinf"  class="bi bi-cloud" @click="executeAct('start','null')" title="Save">Play Null</button>
            <button type="button" :disabled="buttons.pause"  class="bi bi-pause-btn" @click="executeAct('pause')" title="Save">Pause</button>

            <button v-on:click="updateButtons()" class="btn btn-primary btn-sm">Reload status</button>
            <br>
            <br>
        </div>
        <div width="800px">
            <vtabs>
                <vtab name="RECORDINGS">
                    <br>
                    <recording-list
                            v-on:selectrow="rowSelected"
                            v-on:download="download"
                            v-on:reload="reloadForm"
                            ref="recordingList" ></recording-list>
                </vtab>
                <vtab name="SELECTED">
                    <br>
                    <current-line
                            :current-row="selectedRow"
                            ref="currentLine">

                    </current-line>
                </vtab>
                <vtab name="RESULTS">
                    <button v-on:click="reloadResult()" class="bi bi-arrow-clockwise" title="Reload"></button>
                    <br><br>
                    <simple-grid
                            v-on:gridclicked="gridClickedResult"
                            ref="results"
                            :columns="columnsResult"
                            :extra="extraColumnsResult"
                            :retrieve-data="retrieveDataResult"
                    >
                    </simple-grid>
                </vtab>
            </vtabs>

        </div>

    </div>
</div>
<script>
    new Vue({
        el: '#app',
        components: {
            'simple-grid': httpVueLoader('/vcomponents/testgrid.vue'),
            'recording-list': httpVueLoader('/plugins/recording/vcomponents/vlist.vue'),
            'current-line': httpVueLoader('/plugins/recording/vcomponents/vcurrent.vue'),
            'vtab': httpVueLoader('/vcomponents/tab/vtab.vue'),
            'vtabs': httpVueLoader('/vcomponents/tab/vtabs.vue')
        },
        mounted: async function(){
            this.reloadForm();
        },
        data: function () {
            return {
                columnsResult: [
                    {id: "fileId", template: "long", index: true},
                    {id: "date", template: "string"},
                    {id: "name", template: "string"},
                    {id: "testType", template: "string"},
                    {id: "successful", template: "bool"}
                ],
                extraColumnsResult: [
                    {
                        id: "_download", template: "iconbutton", default: false, searchable: false, sortable: false, properties: {
                            name: "Download", style: "bi bi-pen-fill"
                        }
                    },
                    {
                        id: "_delete", template: "iconbutton", default: false, searchable: false, sortable: false, properties: {
                            name: "Delete", style: "bi bi-trash"
                        }
                    }
                ],
                selectedRow:null,
                data:{},
                buttons:{
                    save:false,
                    record:false,
                    stop:true,
                    play:true,
                    pact:true,
                    nullinf:true,
                    pause:true
                }

            }
        },
        methods: {
            retrieveDataResult: async function () {
                var id = getUrlParameter("id");
                var result = await axios.get("/api/plugins/replayer/results?id="+id);
                return result;
            },
            gridClickedResult: async function (evt) {
                var row = this.$refs.results.getById(evt.index);

                if (evt.buttonid == "_download") {
                    window.open("/api/plugins/replayer/results/"+row['fileId']);
                } else if (evt.buttonid == "_delete") {
                    await axios.delete("/api/plugins/replayer/results/" + row['fileId']);
                    this.$refs.results.delete(evt.index)

                }
            },
            reloadResult: function () {
                this.$refs.results.reload();
            },
            executeAct:function(what,onWhat){
                var th = this;
                var id = getUrlParameter("id");
                if(!isUndefined(onWhat)){
                    var id = getUrlParameter("id");
                    var url = "/api/plugins/replayer/recording/"+id+"/"+onWhat+"/"+what;
                    axios.get(url)
                        .then(function (result) {
                            th.updateButtons();
                        });
                }else {
                    axios.get("/api/plugins/replayer/status")
                        .then(function (result) {
                            var data = result.data;
                            data.status = data.status.toUpperCase();
                            data.running = data.running.toUpperCase();

                            if (id == data.running) {
                                if (data.status == "RECORDING")th.executeAct(what,'record');
                                if (data.status == "PAUSED_RECORDING")th.executeAct(what,'record');
                                if (data.status == "REPLAYING")th.executeAct(what,'replay');
                                if (data.status == "PAUSED_REPLAYING")th.executeAct(what,'replay');
                                if (data.status == "PLAYING_NULL_INFRASTRUCTURE")th.executeAct(what,'null');
                                if (data.status == "PLAYING_PACT")th.executeAct(what,'pact');
                            }
                        })
                }
            },
            rowSelected:function(rowId){
                this.selectedRow=rowId;
                sessionStorage.setItem("recordingCurrentLine", rowId);
                sessionStorage.setItem("recordingId", getUrlParameter("id"));
            },
            updateButtons:function(){
                var th=this;
                axios.get("/api/plugins/replayer/status")
                    .then(function(result){
                        var data = result.data;
                        data.status=data.status.toUpperCase();
                        data.running=data.running.toUpperCase();
                        var thisScript =getUrlParameter("id");
                        if(data.status!="NONE" && thisScript!=data.running ){
                            data.status="OTHER_RUNNING";
                        }

                        if(th.data.lines.length==0 && data.status=="NONE"){
                            th.buttons.record=false;
                        }
                        if(data.status=="OTHER_RUNNING"){
                            th.buttons.save=false;
                            th.buttons.stop=true;
                            th.buttons.play=true;
                            th.buttons.pact=true;
                            th.buttons.nullinf=true;
                        }else if(data.status=="RECORDING"||data.status=="REPLAYING"){
                            th.buttons.save=true;
                            th.buttons.stop=false;
                            th.buttons.record=true;
                            th.buttons.pause=false;
                            th.buttons.play=true;
                            th.buttons.pact=true;
                            th.buttons.nullinf=true;
                        }else if(data.status=="PLAYING_NULL_INFRASTRUCTURE"||data.status=="PLAYING_PACT"){
                            th.buttons.save=true;
                            th.buttons.stop=false;
                            th.buttons.pause=true;
                            th.buttons.record=true;
                            th.buttons.play=true;
                            th.buttons.pact=true;
                            th.buttons.nullinf=true;
                        }else if(data.status=="PAUSED_RECORDING"){
                            th.buttons.record=false;
                            th.buttons.save=true;
                            th.buttons.stop=false;
                            th.buttons.pause=true;
                            th.buttons.play=true;
                            th.buttons.pact=true;
                            th.buttons.nullinf=true;
                        }else if(data.status=="PAUSED_REPLAYING"){
                            th.buttons.record=true;
                            th.buttons.save=true;
                            th.buttons.stop=false;
                            th.buttons.pause=true;
                            th.buttons.play=false;
                            th.buttons.pact=true;
                            th.buttons.nullinf=true;
                        }else if(data.status=="NONE"){
                            th.buttons.save=false;
                            th.buttons.stop=true;
                            th.buttons.pause=true;
                            if(th.data.lines.length>0){
                                th.buttons.record=true;
                                th.buttons.play=false;
                                th.buttons.pact=false;
                                th.buttons.nullinf=false;
                            }else{
                                th.buttons.record=false;
                                th.buttons.play=true;
                                th.buttons.pact=true;
                                th.buttons.nullinf=true;
                            }

                        }

                    })
            },
            reloadForm: function(){
                var th=this;
                axios.get("/api/plugins/replayer/v2/recording/" + getUrlParameter("id"))
                    .then(function (result){
                        th.data=result.data;
                        th.$refs.recordingList.reload(th.data.lines);
                        //if(th.data.linse.length>0){
                            th.updateButtons();
                        //}

                        var recording = sessionStorage.getItem("recordingId");
                        if(null!=recording){
                            recording = recording+"";
                            if(recording==getUrlParameter("id")){
                                var current = sessionStorage.getItem("recordingCurrentLine");
                                if(null!=current){
                                    th.selectedRow=parseInt(current);
                                }
                            }
                        }

                    });
            },
            download:function(){
                downloadFile("/api/plugins/replayer/recording/"+getUrlParameter("id")+"/full",this.data.name);
            },
            saveRecordingData:function (){
                var id = getUrlParameter("id");

                var stimulatedTest = [];
                var pactTest = [];
                var stimulatorTest = [];
                console.log("AAAAAAAAAAAA")
                this.data.lines.forEach(function (row, i) {
                    if(row['stimulatedTest']==true){
                        stimulatedTest.push(row['id']);
                    }
                    if(row['pactTest']==true){
                        pactTest.push(row['id']);
                    }
                    if(row['stimulatorTest']==true){
                        stimulatorTest.push(row['id']);
                    }
                });

                var data = {
                    id:id,
                    description: this.data.description,
                    name:this.data.name,
                    filter:{
                        dst:"",
                        src:"",
                        test:""
                    },
                    stimulatorTest:stimulatorTest,
                    pactTest:pactTest,
                    stimulatedTest:stimulatedTest
                };

                const headers = {'Content-Type': 'application/json'};
                axios.put('/api/plugins/replayer/recording/'+id,
                    data, {headers}).then((res) => {

                });
            }
        }
    });
</script>
</body>
</html>