<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link href="/libs/bootstrap.min.css" rel="stylesheet"/>
    <link href="/libs/icons/bootstrap-icons.css" rel="stylesheet"/>
    <script src="/libs/vue.js"></script>
    <script src="/libs/httpVueLoader.js"></script>
    <script src="/libs/axios.min.js"></script>
    <script src="/libs/utils.js"></script>
    <link rel="stylesheet" type="text/css" href="/vcss/style.css" />
</head>
<body>

<div class="container" id="app">
    <div class="row">
        <div class="col-md-8">
            <br>
            <button type="button"  class="btn btn-default" onClick="location.href='../index.html'">Main</button>
            <button type="button"  class="btn btn-default" onClick="location.href='results.html'">Test results</button>
        </div>

        <div class="col-md-8">

            <div class="form-group">
                <label for="id">Id</label>
                <input class="form-control" readonly type="text" name="id" id="id" v-model="data.id"/>
            </div>
            <div class="form-group">
                <label for="name">Name</label>
                <input class="form-control" type="text" name="name" id="name" v-model="data.name"/>
            </div>
            <div class="form-group">
                <label for="description">Description</label>
                <textarea class="form-control" rows="6" cols="50"
                          name="description" id="description"
                          v-model="data.description"></textarea>
            </div>
            <br>
            <button type="button"  class="bi bi-floppy" @click="saveRecordingData" title="Save">Save</button>&nbsp;
            <button type="button"  class="bi bi-record-btn" @click="noop" title="Save">Record</button>&nbsp;
            <button type="button"  class="bi bi-stop-btn" @click="noop" title="Save">Stop</button>&nbsp;
            <button type="button"  class="bi bi-play-btn" @click="noop" title="Save">Play</button>&nbsp;
            <button type="button"  class="bi bi-pencil-square" @click="noop" title="Save">Play Pact</button>&nbsp;
            <button type="button"  class="bi bi-cloud" @click="noop" title="Save">Play Null</button>
            <br>
            <br>
        </div>
        <div width="800px">
            <vtabs>
                <vtab name="RECORDINGS">
                    <br>
                    <recording-list
                            v-on:selectrow="rowSelected"
                            v-on:download="download"
                            v-on:reload="reloadForm"
                            ref="recordingList" ></recording-list>
                </vtab>
                <vtab name="SELECTED">
                    <br>
                    <current-line
                            :current-row="selectedRow"
                            ref="currentLine">

                    </current-line>
                </vtab>
                <vtab name="RESULTS">
                </vtab>
            </vtabs>

        </div>

    </div>
</div>
<script>
    new Vue({
        el: '#app',
        components: {
            'simple-grid': httpVueLoader('/vcomponents/testgrid.vue'),
            'recording-list': httpVueLoader('/plugins/recording/vcomponents/vlist.vue'),
            'current-line': httpVueLoader('/plugins/recording/vcomponents/vcurrent.vue'),
            'vtab': httpVueLoader('/vcomponents/tab/vtab.vue'),
            'vtabs': httpVueLoader('/vcomponents/tab/vtabs.vue')
        },
        mounted: async function(){
            this.reloadForm();
        },
        data: function () {
            return {
                selectedRow:null,
                data:{}

            }
        },
        methods: {
            noop:function(){},
            rowSelected:function(rowId){
                this.selectedRow=rowId;
                sessionStorage.setItem("recordingCurrentLine", rowId);
                sessionStorage.setItem("recordingId", getUrlParameter("id"));
            },
            reloadForm: function(){
                var th=this;
                axios.get("/api/plugins/replayer/v2/recording/" + getUrlParameter("id"))
                    .then(function (result){
                        th.data=result.data;
                        th.$refs.recordingList.reload(th.data.lines);

                        var recording = sessionStorage.getItem("recordingId");
                        if(null!=recording){
                            recording = recording+"";
                            if(recording==getUrlParameter("id")){
                                var current = sessionStorage.getItem("recordingCurrentLine");
                                if(null!=current){
                                    th.selectedRow=parseInt(current);
                                }
                            }
                        }

                    });
            },
            download:function(){
                downloadFile("/api/plugins/replayer/recording/"+getUrlParameter("id")+"/full",this.data.name);
            },
            saveRecordingData:function (){
                var id = getUrlParameter("id");

                var stimulatedTest = [];
                var pactTest = [];
                var stimulatorTest = [];
                console.log("AAAAAAAAAAAA")
                this.data.lines.forEach(function (row, i) {
                    if(row['stimulatedTest']==true){
                        stimulatedTest.push(row['id']);
                    }
                    if(row['pactTest']==true){
                        pactTest.push(row['id']);
                    }
                    if(row['stimulatorTest']==true){
                        stimulatorTest.push(row['id']);
                    }
                });

                var data = {
                    id:id,
                    description: this.data.description,
                    name:this.data.name,
                    filter:{
                        dst:"",
                        src:"",
                        test:""
                    },
                    stimulatorTest:stimulatorTest,
                    pactTest:pactTest,
                    stimulatedTest:stimulatedTest
                };

                const headers = {'Content-Type': 'application/json'};
                axios.put('/api/plugins/replayer/recording/'+id,
                    data, {headers}).then((res) => {

                });
            }
        }
    });
</script>
</body>
</html>